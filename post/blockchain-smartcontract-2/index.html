<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>比特币中的智能合约 - JMaxU&#39;s blog</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="景旭" />
  <meta name="description" content="说起智能合约, 往往想到的不是比特币, 而是以太坊等其他区块链. 其实比特币也是有智能合约的, 之所以比特币被称为可编程货币, 就是因为比特币的智能合" />

  <meta name="keywords" content="JMaxU, architecture, 景旭" />






<meta name="generator" content="Hugo 0.30.2" />


<link rel="canonical" href="http://jmaxu.github.io/post/blockchain-smartcontract-2/" />

<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" href="/favicon.ico" />
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">







<link href="/dist/even.min.css?v=2.7.0" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">

<meta property="og:title" content="比特币中的智能合约" />
<meta property="og:description" content="说起智能合约, 往往想到的不是比特币, 而是以太坊等其他区块链. 其实比特币也是有智能合约的, 之所以比特币被称为可编程货币, 就是因为比特币的智能合" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://jmaxu.github.io/post/blockchain-smartcontract-2/" />



<meta property="article:published_time" content="2017-12-29T20:45:37&#43;08:00"/>

<meta property="article:modified_time" content="2017-12-29T20:45:37&#43;08:00"/>











<meta itemprop="name" content="比特币中的智能合约">
<meta itemprop="description" content="说起智能合约, 往往想到的不是比特币, 而是以太坊等其他区块链. 其实比特币也是有智能合约的, 之所以比特币被称为可编程货币, 就是因为比特币的智能合">


<meta itemprop="datePublished" content="2017-12-29T20:45:37&#43;08:00" />
<meta itemprop="dateModified" content="2017-12-29T20:45:37&#43;08:00" />
<meta itemprop="wordCount" content="4601">



<meta itemprop="keywords" content="区块链,比特币," />
<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="比特币中的智能合约"/>
<meta name="twitter:description" content="说起智能合约, 往往想到的不是比特币, 而是以太坊等其他区块链. 其实比特币也是有智能合约的, 之所以比特币被称为可编程货币, 就是因为比特币的智能合"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">JMaxU&#39;s blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">首页</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">归档</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">标签</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">分类</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">JMaxU&#39;s blog</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">首页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">归档</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">标签</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">分类</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">比特币中的智能合约</h1>

      <div class="post-meta">
        <span class="post-time"> 2017-12-29 </span>
        <div class="post-category">
            
              <a href="/categories/%E6%8A%80%E6%9C%AF/"> 技术 </a>
            
          </div>
        <span class="more-meta"> 约 4601 字 </span>
        <span class="more-meta"> 预计阅读 10 分钟 </span>
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#一个简单交易">一个简单交易</a></li>
<li><a href="#一个多签交易">一个多签交易</a></li>
<li><a href="#一个自定义交易">一个自定义交易</a></li>
</ul></li>
</ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      

<p>说起智能合约, 往往想到的不是比特币, 而是以太坊等其他区块链.
其实比特币也是有智能合约的, 之所以比特币被称为可编程货币, 就是因为比特币的智能合约.
比特币区块是由一个又一个交易组成的, 而比特币的智能合约就存在于这些交易中.
交易有输出, 有输出. 在输入与输出中都含有一段脚本, 这两段存在于输入与输出中的脚本就是比特币中的智能合约.</p>

<p>接下来, 我们通过一个简单交易, 一个多签交易以及一个自定义的交易来了解一下比特币中的智能合约.</p>

<blockquote>
<p>以下简单交易与多签交易中的例子, 取自<code>mastering bitcoin</code>.</p>
</blockquote>

<h2 id="一个简单交易">一个简单交易</h2>

<p>如下是真实存在于比特币区块链里的一个简单交易.
为了便于阐述, 假设这个交易是小帅在小强那里购买了一部iphone, 小帅支付给了小强0.0845个比特币.</p>

<p>交易内容如下:</p>

<pre><code>{
    &quot;version&quot;: 1,
    &quot;locktime&quot;: 0,
    &quot;vin&quot;: [
        {
            &quot;txid&quot;: &quot;7957a35fe64f80d234d76d83a2a8f1a0d8149a41d81de548f0a65a8a999f6f18&quot;,
            &quot;vout&quot;: 0,
            &quot;scriptSig&quot;: &quot;3045022100884d142d86652a3f47ba4746ec719bbfbd040a570b1deccbb6498c75c4ae24cb02204b9f039ff08df09cbe9f6addac960298cad530a863ea8f53982c09db8f6e3813[ ALL] 0484ecc0d46f1918b30928fa0e4ed99f16a0fb4fde0735e7ade8416ab9fe423cc5412336376789d172787ec3457eee41c04f4938de5cc17b4a10fa336a8d752adf&quot;,
            &quot;sequence&quot;: 4294967295
        }
    ],
    &quot;vout&quot;: [
        {
            &quot;value&quot;: 0.01500000,
            &quot;scriptPubKey&quot;: &quot;OP_DUP OP_HASH160 7f9b1a7fb68d60c536c2fd8aeaa53a8f3cc025a8 OP_EQUALVERIFY OP_CHECKSIG&quot;,
        },
        {
            &quot;value&quot;: 0.08450000,
            &quot;scriptPubKey&quot;: &quot;OP_DUP OP_HASH160 ab68025513c3dbd2f7b92a94e0581f5d50f654e7 OP_EQUALVERIFY OP_CHECKSIG&quot;
        }
    ]
}
</code></pre>

<p>初看这个交易内容会一脸蒙逼, 到底是个什么玩意? 智能合约在哪里?
不要担心, 接下来我们一起一步一步解读一下这个交易.</p>

<p><strong>首先小帅既然支付给了小强0.0845个比特币, 那么小帅的比特币在哪里呢?</strong></p>

<p>比特币中的输入与输出, 表示币从哪里到了哪里.
每个输出里都有一个金额(value), 可以理解为就是这个输出所拥有的比特币数额.
每个输出里也都有一个脚本(scriptPubKey), 我们称输出里的这个脚本为<code>解锁脚本</code>, 解锁脚本可以理解为是一道题. 只要有人能解出输出里的这个题, 那么这个输出里的比特币就属于解出题的这个人.</p>

<p>所以小帅的比特币就在所有能够被小帅解出的交易输出里.
而小帅的比特币余额就是所有能能被小帅解出的交易输出中比特币金额的总和.</p>

<p>所以可以理解为一个又一个的交易所做就是把比特币从一个输出里转到另一个输出里.
而交易里输入的作用就是在解某个输出里的题.</p>

<p>回过头来看小帅支付给小强的这个交易的输入:</p>

<pre><code>    &quot;vin&quot;: [
        {
            &quot;txid&quot;: &quot;7957a35fe64f80d234d76d83a2a8f1a0d8149a41d81de548f0a65a8a999f6f18&quot;,
            &quot;vout&quot;: 0,
            &quot;scriptSig&quot;: &quot;3045022100884d142d86652a3f47ba4746ec719bbfbd040a570b1deccbb6498c75c4ae24cb02204b9f039ff08df09cbe9f6addac960298cad530a863ea8f53982c09db8f6e3813[ ALL] 0484ecc0d46f1918b30928fa0e4ed99f16a0fb4fde0735e7ade8416ab9fe423cc5412336376789d172787ec3457eee41c04f4938de5cc17b4a10fa336a8d752adf&quot;,
            &quot;sequence&quot;: 4294967295
        }
    ],
</code></pre>

<p><code>txid</code>表示引用某个交易, <code>vout</code>代表所引用交易中的第几个输出, <code>scriptSig</code>是一段脚本, 我们称为解锁脚本, 可以理解为解题答案.
整个输入可以理解为用<code>scriptSig</code>中的解锁脚本去解交易<code>txid</code>中的第<code>vout</code>输出中的锁定脚本.</p>

<p>也就是小帅要用解锁脚本<code>scriptSig</code>去解某个交易的输出, 以证明自己拥有这个输出里的比特币.</p>

<p>这个输入中引用的交易<code>txid:7957a35fe64f80d234d76d83a2a8f1a0d8149a41d81de548f0a65a8a999f6f18</code>的第<code>vout:0</code>输出如下:</p>

<pre><code> &quot;vout&quot;: [
        {
            &quot;value&quot;: 0.1,
            &quot;scriptPubKey&quot;: &quot;OP_DUP OP_HASH160  7f9b1a7fb68d60c536c2fd8aeaa53a8f3cc025a8 OP_EQUALVERIFY OP_CHECKSIG&quot;
        }
    ]
</code></pre>

<p>小帅证明了这个输出中的0.1个比特币属于自己并把其中的0.0845个比特币支付给了小强.
那么剩下的0.1-0.0845=0.0155到哪里去了?</p>

<p>回头再看小帅支付给小强的交易中的输出:</p>

<pre><code>    &quot;vout&quot;: [
        {
            &quot;value&quot;: 0.01500000,
            &quot;scriptPubKey&quot;: &quot;OP_DUP OP_HASH160 7f9b1a7fb68d60c536c2fd8aeaa53a8f3cc025a8 OP_EQUALVERIFY OP_CHECKSIG&quot;,
        },
        {
            &quot;value&quot;: 0.08450000,
            &quot;scriptPubKey&quot;: &quot;OP_DUP OP_HASH160 ab68025513c3dbd2f7b92a94e0581f5d50f654e7 OP_EQUALVERIFY OP_CHECKSIG&quot;
        }
    ]
</code></pre>

<p>我们看到除了支付给小强的0.0845外, 还有一个金额为0.015的输出.
仔细观察可以发现0.015这个输出中的<code>scriptPubKey</code>与0.1这个输出中的<code>scriptPubKey</code>相等. 也就是说交易输出里的0.015比特币又支付给了交易输入里所引用的交易输出.
也就是说这个0.015的输出其实是做为找零又支付给了小帅自己.</p>

<p>可我们发现, 输入与输出并不相等, 输入为0.1, 输出为0.0845+0.015=0.995,  差了个0.005.
而这0.005比特币作为交易费付给了矿工.</p>

<p>再梳理一遍:</p>

<ul>
<li>小帅要给小强支付比特币.</li>
<li>比特币存在于交易输出里, 被锁定脚本锁定.</li>
<li>小帅的比特币就在小帅能解锁的所有的交易输出里.</li>
<li>小帅在自己所能解锁的输出里选择了一个数额为0.1比特币的交易输出.</li>
<li>小帅提供自己的解锁脚本来证明0.1比特币属于自己.</li>
<li>小帅把0.1比特币中的0.0845支付给了小强, 0.015找零给了自己, 0.005作为交易费给了矿工.</li>
</ul>

<p>接下来咱们就一起解剖一下上述例子中的锁定脚本与解锁脚本.</p>

<p>在比特币中解锁脚本与锁定脚本是拼接在一起执行的, 如果返回结果为1, 则解锁成功, 否则为解锁失败.
如下是这个简单交易中解锁脚本与锁定脚本拼接在一起在示意图:
<img src="http://static.zybuluo.com/a617137379/pxihzr7mpzkaowlqsup8ja5g/image_1c120avjl2roqaika0v1gnm9.png" alt="image_1c120avjl2roqaika0v1gnm9.png-92.7kB" />
这个图中将解锁脚本(unlocking script)与锁定脚本(locking script)拼接在了一起.
其中用<code>&lt;&gt;</code>标示的是数据, 如<code>&lt;Sig&gt;&lt;PubKHash&gt;</code>.
未用<code>&lt;&gt;</code>标示的是比特币提供的操作指令, 如DUP, HASH160. 操作指令就是用来操作数据的.</p>

<p>比特币脚本是一个基于栈的语言, 数据会被压进栈, 操作指令会取(pop)栈中元素进行操作并把结果再压进栈.
先举一个最最简单的锁定脚本与解锁脚本例子, 如下:
锁定脚本:<code>3 OP_ADD 5 OP_EQUAL</code>.
解锁脚本:<code>2</code>.
将解锁脚本与锁定脚本拼接:<code>2 3 OP_ADD 5 OP_EQUAL</code>.
脚本的执行过程如下:
<img src="http://static.zybuluo.com/a617137379/os1y94m5rzs93odff5irz61j/image_1c1258608n9e1hip1s2d1j0k1c929.png" alt="image_1c1258608n9e1hip1s2d1j0k1c929.png-162.5kB" /></p>

<ul>
<li>脚本中前两个元素<code>2 3</code>都是数据, 依次推进栈里.</li>
<li>脚本中第三个元素<code>ADD</code>为操作指令, <code>ADD</code>操作指令会将之前推进栈里的两个元素pop出来进行求合, 并把结果返回栈里. 这时栈里只剩一个元素<code>5</code></li>
<li>脚本中第四个元素<code>5</code>是数据, 推进栈里. 这时候, 栈里有两个元素, 都是<code>5</code>.</li>
<li>脚本中最后一个元素<code>EQUAL</code>是操作指令, <code>EQUAL</code>操作指令将栈里的两个元素, 也就是两个<code>5</code>, 取出进行比对, 如果相待则返回true(用数字1表示). 显然5与5相等, 解锁成功.</li>
</ul>

<p>看完最最简单的例子后, 回过头来, 再看小帅支付给小强这个简单交易.</p>

<blockquote>
<p>深入剖析之前, 需要先复习一下非对称加密:</p>

<ul>
<li>有一对密钥, 一个为公钥, 一个为私钥.</li>
<li>公钥是公开的, 人人都能知道, 私钥是不公开.</li>
<li>公钥进行加密, 私钥进行解密.</li>
<li>私钥进行签名, 公钥进行验签.
比特币中并未用到非对称加密中的加密, 只用于了签名.</li>
</ul>
</blockquote>

<p>在这个简单交易里, 小帅用自己的解锁脚本去解一个数额为0.1比特币的输出, 证明这0.1比特币属于自己.
交易输入如下:</p>

<pre><code>    &quot;vin&quot;: [
        {
            &quot;txid&quot;: &quot;7957a35fe64f80d234d76d83a2a8f1a0d8149a41d81de548f0a65a8a999f6f18&quot;,
            &quot;vout&quot;: 0,
            &quot;scriptSig&quot;: &quot;3045022100884d142d86652a3f47ba4746ec719bbfbd040a570b1deccbb6498c75c4ae24cb02204b9f039ff08df09cbe9f6addac960298cad530a863ea8f53982c09db8f6e3813[ ALL] 0484ecc0d46f1918b30928fa0e4ed99f16a0fb4fde0735e7ade8416ab9fe423cc5412336376789d172787ec3457eee41c04f4938de5cc17b4a10fa336a8d752adf&quot;,
            &quot;sequence&quot;: 4294967295
        }
    ],
</code></pre>

<p>解锁脚本<code>scriptSig</code>为:</p>

<pre><code>3045022100884d142d86652a3f47ba4746ec719bbfbd040a570b1deccbb6498c75c4ae24cb02204b9f039ff08df09cbe9f6addac960298cad530a863ea8f53982c09db8f6e3813[ ALL] 0484ecc0d46f1918b30928fa0e4ed99f16a0fb4fde0735e7ade8416ab9fe423cc5412336376789d172787ec3457eee41c04f4938de5cc17b4a10fa336a8d752adf
</code></pre>

<p>第一串数字为小帅的签名, 第二串数字为小帅的公钥, 如下:</p>

<pre><code>&lt;小帅的签名-sig&gt; &lt;小帅的公钥-PubK&gt;
</code></pre>

<p>交易输入所引用的输出, 如下:</p>

<pre><code> &quot;vout&quot;: [
        {
            &quot;value&quot;: 0.1,
            &quot;scriptPubKey&quot;: &quot;OP_DUP OP_HASH160  7f9b1a7fb68d60c536c2fd8aeaa53a8f3cc025a8 OP_EQUALVERIFY OP_CHECKSIG&quot;
        }
    ]
</code></pre>

<p>锁定脚本<code>OP_DUP OP_HASH160  7f9b1a7fb68d60c536c2fd8aeaa53a8f3cc025a8 OP_EQUALVERIFY OP_CHECKSIG</code>为:
中间那串数据为小帅公钥的hash, 如下:</p>

<pre><code>OP_DUP OP_HASH160 &lt;小帅的公钥hash-PubKHash&gt; OP_EQUALVERIFY OP_CHECKSIG
</code></pre>

<p>把解锁脚本与锁定脚本拼在一起:</p>

<pre><code>&lt;小帅的签名-sig&gt; &lt;小帅的公钥-PubK&gt; OP_DUP OP_HASH160 &lt;小帅的公钥hash-PubKHash&gt; OP_EQUALVERIFY OP_CHECKSIG
</code></pre>

<p>以下是这个脚本的执行过程,
图中<code>&lt;sig&gt;</code>就是小强的签名, <code>&lt;PubK&gt;</code>就是小强的公钥. <code>&lt;PubKHash&gt;</code>就是小强公钥的hash:
<img src="http://static.zybuluo.com/a617137379/erv7jr9qqr99mx4935hjgoib/image_1c1270cloe4v16v8b6fpb1rt99.png" alt="image_1c1270cloe4v16v8b6fpb1rt99.png-160.4kB" />
<img src="http://static.zybuluo.com/a617137379/c8fb4yvd4jn0h3fbef33gtui/image_1c127125d1vj31q1o193pi2e1m9hm.png" alt="image_1c127125d1vj31q1o193pi2e1m9hm.png-257.3kB" /></p>

<p>过程描述如下:</p>

<ul>
<li>脚本的前两个元素<code>&lt;sig&gt;&lt;PubK&gt;</code>为数据, 推进栈.</li>
<li>脚本的第三个元素<code>DUP</code>为指令, <code>DUP</code>指令会把栈顶元素<code>&lt;PubK&gt;</code>复制一份并压进栈.</li>
<li>脚本的第四个元素<code>HASH160</code>为指令, <code>HASH160</code>指令会把栈顶元素<code>&lt;PubK&gt;</code>进行hash160操作再压进栈.</li>
<li>脚本的第五个元素<code>&lt;PubKHash&gt;</code>为数据, 压进栈.</li>
<li>脚本的第六个元素<code>EQUALVERIFY</code>为指令, 会弹出两个元素进行对比. 如果相待继续执行, 如果不等脚本退出, 执行失败.</li>
<li>现在栈里剩下<code>&lt;sig&gt;&lt;PubK&gt;</code>两个元素, 脚本的最后一个元素<code>CHECKSIG</code>为指令, 就是对最后剩下的这两个元素进行判断, 用第一个元素<code>&lt;PubK&gt;</code>去验证<code>&lt;sig&gt;</code>是否正确, 也就是用公钥去验证签名.</li>
<li>如果可以验证成功, 则证明小帅拥有这个输出里的这0.1个比特币.</li>
</ul>

<p>这种类型的脚本或是说<code>智能合约</code>在比特币里最为常见.
我们把这种交易命名<code>Pay-to-Public-Key-Hash (P2PKH)</code>, 中文译为<code>支付给公钥</code>.</p>

<p>除了这种<code>合约</code>, 还有一种复杂点的<code>合约</code>也比较常见, 叫<code>Multisignature</code>, 多签交易.</p>

<h2 id="一个多签交易">一个多签交易</h2>

<p>了解了简单交易, 了解多签交易就简单了.
多签交易可以理解为把比特币支付给了一堆公钥地址, 需要这堆公钥地址中的某几个或全部提供签名才能解锁.</p>

<p>多签锁定脚本的一般形式如下:</p>

<pre><code>M &lt; Public Key 1 &gt; &lt; Public Key 2 &gt; ... &lt; Public Key N &gt; N CHECKMULTISIG
</code></pre>

<p>需要提供锁定脚本里这N个公钥中的M个公钥所对应的私钥才能解锁脚本.</p>

<p>比如下面这个多签解锁脚本:</p>

<pre><code>2 &lt; Public Key A &gt; &lt; Public Key B &gt; &lt; Public Key C &gt; 3 CHECKMULTISIG
</code></pre>

<p>需要要提供三个公钥中的两个公钥所对应的私钥才能解锁脚本. 比如:</p>

<pre><code>&lt; Signature B &gt; &lt; Signature C &gt;
</code></pre>

<p>把解锁脚本与锁定脚本拼在一起</p>

<pre><code>&lt; Signature B &gt; &lt; Signature C &gt; 2 &lt; Public Key A &gt; &lt; Public Key B &gt; &lt; Public Key C &gt; 3 CHECKMULTISIG
</code></pre>

<p>这个脚本把除了最后个元素<code>CHECKMULTISIG</code>为指令外其他都为数据.
<code>CHECKMULTISIG</code>指令很强大, 它会判断解锁脚本中是否提供了锁定脚本里3个公钥中的2个公钥所对应的正确签名.</p>

<p>除了简单交易-支付给公钥与多签交易后, 其实还有一个目前广泛使用的更加强大的<code>Pay-to-Script-Hash (P2SH)</code>, 支付给脚本.</p>

<p>虽然多签很强大, 但是使用起来并不方便:</p>

<ul>
<li>每次支付都需要收款方提供一下锁定脚本. 因为支付方需要在交易的输出里写入这个锁定脚本.</li>
<li>因为其中包含了多个公钥, 锁定脚本往往很大, 导致交易大小很大, 导致交易费很高. 明明的收款方的原因, 却要由支付方来承担, 不合理.</li>
</ul>

<p>这时<code>Pay-to-Script-Hash (P2SH)</code>支付给脚本方式的交易诞生了, 解决了上述的问题. 这个很牛逼.</p>

<p><code>P2SH</code>之前的多签脚本:
锁定脚本:<code>2 PubKey1 PubKey2 PubKey3 PubKey4 PubKey5 5 CHECKMULTISIG</code>
解锁脚本:<code>Sig1 Sig2</code></p>

<p><code>P2SH</code>之后的多签脚本:
赎回脚本:<code>2 PubKey1 PubKey2 PubKey3 PubKey4 PubKey5 5 CHECKMULTISIG</code>
锁定脚本:<code>HASH160 &lt;赎回脚本的hash值&gt; EQUAL</code>
解锁脚本:<code>Sig1 Sig2 &lt;赎回脚本&gt;</code></p>

<blockquote>
<p>赎回脚本这里是我自己翻遍的. 英文为<code>Redeem Script</code>.</p>
</blockquote>

<p>可以看出原来的锁定脚本现在变为赎回脚本放到了解锁脚本里, 而现在的锁定脚本只记录了赎回脚本也就是原来锁定脚本的hash值.这大大减轻了锁定脚本的大小.</p>

<p>把解锁脚本与锁定脚本拼接在一起:
<code>Sig1 Sig2 &lt;赎回脚本&gt; HASH160 &lt;赎回脚本的hash值&gt; EQUAL</code></p>

<p>执行过程:</p>

<ul>
<li>将Sig1, Sig2, 赎回脚本都是数据. 依次推进栈.</li>
<li><code>HASH160</code>为指令. 从栈顶取出赎回脚本计算hash值, 将hash结果推进栈.</li>
<li><code>&lt;赎回脚本的hash值&gt;</code>为数据, 推进栈.</li>
<li>这时栈前两个元素都是赎回脚本的hash值.指令<code>EQUAL</code>取出这两个hash值, 并对比这两个值是否相等.</li>
<li>如果相等, 则执行赎回脚本. 这时执行的逻辑和多签脚本中所说的逻辑一致.</li>
</ul>

<p>解锁脚本与锁定脚本可以按照自己的需求来编写, 只要符合比特币的规则.
接下来看一个自定义的脚本或合约的例子.</p>

<h2 id="一个自定义交易">一个自定义交易</h2>

<p>设计这么一个脚本或是合约, 达到以下目的:</p>

<ul>
<li>只要有小帅, 小强, 小壮, 3个人中的2个人的签名, 可以解锁锁定脚本.</li>
<li>或者只有小景的签名, 可以解锁脚本.</li>
</ul>

<p>那么这个合约, 可以这样写:</p>

<pre><code>IF
 2 &lt;小帅公钥&gt; &lt;小强公钥&gt; &lt;小壮公钥&gt; 3 CHECKMULTISIG
ELSE
 OP_DUP OP_HASH160 &lt;小景公钥的hash&gt; OP_EQUALVERIFY OP_CHECKSIG
ENDIF
</code></pre>

<p>如果小帅, 小强, 小壮想解锁脚本, 则解锁脚本如下:</p>

<pre><code>&lt;小帅签名&gt; &lt;小强签名&gt; true
</code></pre>

<p>如果小景想解锁脚本, 则解锁脚本如下:</p>

<pre><code>&lt;小景签名&gt; &lt;小景公钥&gt; false
</code></pre>

<p>这两个解锁脚本后面的<code>true</code>与<code>false</code>是为了控制锁定脚本中的条件语句的.
<code>IF</code>指令会取出栈顶元素, 如果为<code>true</code>, 则执行IF分支 如果为<code>false</code>则执行ELSE分支.</p>

    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">景旭</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">2017-12-29</span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>

    
    

    <footer class="post-footer">
      <div class="post-tags">
          
          <a href="/tags/%E5%8C%BA%E5%9D%97%E9%93%BE/">区块链</a>
          
          <a href="/tags/%E6%AF%94%E7%89%B9%E5%B8%81/">比特币</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/blockchain-smartcontract-3/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">搭建一个私有网络的区块链</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        
          <a class="next" href="/post/stompoverwebsocket/">
            <span class="next-text nav-default">stomp over websocket协议原理与实现</span>
            <span class="prev-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        
  

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:woshijingxu@gmail.com" class="iconfont icon-email" title="email"></a>
  <a href="http://jmaxu.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    
      2017 - 
    2018
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">景旭</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
<script src="/lib/highlight/highlight.pack.js?v=20171001"></script>
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>
<script type="text/javascript" src="/dist/even.min.js?v=2.7.0"></script>

<script id="baidu_analytics">
  var _hmt = _hmt || [];
  (function() {
    if (window.location.hostname === 'localhost') return;
    var hm = document.createElement("script"); hm.async = true;
    hm.src = "https://hm.baidu.com/hm.js?d810cee368eb12bfc47ed60da16a3214";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
  })();
</script>


</body>
</html>
